const mongoose = require("mongoose");
const userschema = require("../models/userSchema");
let users = mongoose.model("users", userschema);
let localStorag = require("local-storage");
const  {SendMessage} = require("./SendMessagFunction")
const SignUp = (req, res) => {
  const phone = req.body.phone;
  users
    .findOne({ phone: phone })
    .then((user) => {
      if (user) {
        res.json({ exist: true, message: "user already exists" });
      } else {
        res.json({ exist: false });
        console.log(req.body);
        const verification_code = Math.random()
          .toString(10)
          .substring(2, 2 + 4);
          SendMessage(phone,` ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ùˆ   ${ verification_code}`);
          localStorag.set("verification_code", verification_code); 
        localStorag.set("user", req.body);
         
      
      }
    })
    .catch((err) => console.log(err.message));
};

const verification = (req, res) => {
  if (req.body.code === localStorag.get("verification_code")) {
    res.json({
      verification: true,
      message: "ØªÙ… Ø§Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­",
      user: localStorag.get("user"),
    });
    const user = new users(localStorag.get("user"));
    SendMessage(user.phone,` Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡  ${user.name.split(" ")[0]} ðŸ¥°  Ù„Ù‚Ø¯ ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø®Ø¯Ù…Ø© Ø§ÙŠØ§Øª`);
    user.save().then((result) => {
      console.log("User added", result);
      
    });
  } else {
    res.json({ verification: false });
  }
};
module.exports = {
  SignUp,
  verification,
};
